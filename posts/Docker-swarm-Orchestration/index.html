<!DOCTYPE html><html lang="ko-KR" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.0" /><meta property="og:title" content="🐋 Docker swarm Orchestration" /><meta name="author" content="minpeter" /><meta property="og:locale" content="ko_KR" /><meta name="description" content="소개 해당 포스트는 도커안에 도커 (dind)기능을 이용해 로컬에서 클러스터와 유사한 환경을 구성하고, docker swarm을 이용해 클러스터를 제어하는 Orchestration을 실습하는 방법에 대한 포스팅이다." /><meta property="og:description" content="소개 해당 포스트는 도커안에 도커 (dind)기능을 이용해 로컬에서 클러스터와 유사한 환경을 구성하고, docker swarm을 이용해 클러스터를 제어하는 Orchestration을 실습하는 방법에 대한 포스팅이다." /><link rel="canonical" href="https://minpeter.github.io/posts/Docker-swarm-Orchestration/" /><meta property="og:url" content="https://minpeter.github.io/posts/Docker-swarm-Orchestration/" /><meta property="og:site_name" content="minpeter" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-09-09T11:12:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="🐋 Docker swarm Orchestration" /><meta name="twitter:site" content="@minpeter2" /><meta name="twitter:creator" content="@minpeter" /><meta name="google-site-verification" content="RNVL00kQq_OXnyYh9S4hgL35tPhS5wdFNf_qNiXhxS8" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"minpeter"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://minpeter.github.io/posts/Docker-swarm-Orchestration/"},"description":"소개 해당 포스트는 도커안에 도커 (dind)기능을 이용해 로컬에서 클러스터와 유사한 환경을 구성하고, docker swarm을 이용해 클러스터를 제어하는 Orchestration을 실습하는 방법에 대한 포스팅이다.","url":"https://minpeter.github.io/posts/Docker-swarm-Orchestration/","@type":"BlogPosting","headline":"🐋 Docker swarm Orchestration","dateModified":"2021-09-13T16:14:46+09:00","datePublished":"2021-09-09T11:12:00+09:00","@context":"https://schema.org"}</script><title>🐋 Docker swarm Orchestration | minpeter</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="minpeter"><meta name="application-name" content="minpeter"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-6FQKWLZK1S"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-6FQKWLZK1S'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/profile_4.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">minpeter</a></div><div class="site-subtitle font-italic">Development Blog! TIL, Dev Log, Etc..</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/minpeter" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/minpeter2" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['kali2005611','gmail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>🐋 Docker swarm Orchestration</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>🐋 Docker swarm Orchestration</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> minpeter </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Sep 9, 2021, 11:12 AM +0900" prep="on" > Sep 9 <i class="unloaded">2021-09-09T11:12:00+09:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Mon, Sep 13, 2021, 12:14 AM -0700" prefix="Updated " > Sep 13 <i class="unloaded">2021-09-13T16:14:46+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2221 words">12 min</span></div></div><div class="post-content"><h1 id="소개">소개</h1><p>해당 포스트는 도커안에 도커 (dind)기능을 이용해 로컬에서 클러스터와 유사한 환경을 구성하고,<br /> docker swarm을 이용해 클러스터를 제어하는 Orchestration을 실습하는 방법에 대한 포스팅이다.</p><h2 id="docker-swarm-orchestration이란">docker swarm, Orchestration이란?</h2><p>docker swarm은 kubernetes와 같은 Orchestration tool이다.<br /> 예를 들어 5대의 서버가 있다고 생각해보자<br /> Orchestration tool을 사용하지 않을 경우는 각각 서버에 동일한 기능을 하도록 설정하거나, 각자 특정기능을 담당하는 식으로 설정해야될 것이다.<br /> 하지만 이 경우 특정 기능이나 서비스에 많은 요청이 들어올경우, 직접 수동으로 해당 서비스를 더 많이 만들어주어야 한다.<br /> 하지만 Orchestration tool을 이용하면 설정값에 따라 특정 서비스를 생성하고 유지하기 때문에 부하가 많이 걸릴시 설정만 바꿔주면 되고 해당 작업 또한 자동화 할 수 있게된다.<br /> 또 서비스를 업데이트 할때 서비스를 종료하지않고 배포하는 것이 가능하다.<br /> (특정 서버에 서비스를 몰아서 배치하는 것이 아닌 분산하여 배치하기 때문에 순차적으로 배포를 진행하면 중단하지 않고도 가능하다.)<br /> 배포를 하였을때 해당 배포에 문제가 생긴 경우 배포를 중단하고 원래 배포전 상태로 돌려주고, 서비스에 문제가 생겨 종료된 경우 자동으로 재시작도 진행해준다.<br /> 이처럼 서비스가 배포중에도 중단되지않고 꺼지지 않아야 하는 경우 사용하면 좋은 도구이다.</p><h2 id="docker-swarm에서-사용하는-용어-설명">docker swarm에서 사용하는 용어 설명</h2><p>|이름|역활| |:—:|:—:| |compose|여러 컨테이너로 구성된 도커 애플리케션을 관리함| |swarm|클러스터 구축 및 관리| |service|기본적인 배포단위, swarm에서 클러스터 안의 서비스을 관리, 기본 docker에서 run과 비슷하다| |stack|swarm에서 여러 개의 서비스를 합함 전체 애플리케이션을 관리| |node|swarm 클러스터에 속한 도커 서버의 단위| |manager node|스윔 클러스터의 상태를 관리하는 노드, 동시에 worker node가 될 수 있고, 여기에서만 swarm명령어를 실행할수 있다.| |worker node|manager node의 명령을 받아 컨테이너를 생성, 상태를 체크하는 노드| |task|컨테이너 배포 단위, 서비스는 여러개의 task을 실행, task는 컨테이너를 관리한다|</p><h1 id="docker-swarm-실습">docker swarm 실습</h1><p>docker swarm은 기본적으로 여러개의 서버를 관리하는 툴이다.<br /> 하지만 우리가 실습할때는 대부분 노트북 하나만을 가지고 실습을 할 것이다.<br /> 따라서 실제 환경과는 조금 다른 가상 실습환경을 만들것이다.<br /> 다양한 방법이 있지만 dind (docker in docker)기능을 활용해서 도커 컨테이너를 각각 노드로 사용하여 실습하도록하겠다.<br /> (다른 방법으로는 vagrant을 이용해 가상머신을 생성해주거나 클라우드서비스를 이용해 실제 클러스터를 구현할수도)<br /> docker compose을 이용해서 1개의 manager node(dind)와 3개의 worker node(dind)을 생성해줄것이다.<br /> 참고한 기존 블로그 글에서는 registy컨테어너가 별도로 존재했지만 실습결과 딱히 필요성을 느끼지 못해 삭제하였다.<br /> (docker registy는 docker hub를 대체하는 로컬서버정도로 이해하면 될 것 같다.)</p><h2 id="가상클러스터-생성">가상클러스터 생성</h2><p>docker-swarm 디렉토리를 생성하고 그 안에 아래의 코드를 참조해 파일을 만들어주자.<br /> <strong>docker-compose.yaml</strong></p><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3"</span>
<span class="na">services</span><span class="pi">:</span>
    <span class="na">manager</span><span class="pi">:</span>
        <span class="na">container_name</span><span class="pi">:</span> <span class="s">manager</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">docker:dind</span>
        <span class="na">privileged</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">tty</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">8000:80</span>
            <span class="pi">-</span> <span class="s">9000:9000</span>
        <span class="na">depends_on</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">registry</span>
        <span class="na">expose</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="m">3375</span>
        <span class="na">volumes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">./stack:/stack"</span>
    <span class="na">worker01</span><span class="pi">:</span>
        <span class="na">container_name</span><span class="pi">:</span> <span class="s">worker01</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">docker:dind</span>
        <span class="na">privileged</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">tty</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">depends_on</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">manager</span>
            <span class="pi">-</span> <span class="s">registry</span>
        <span class="na">expose</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="m">7946</span>
            <span class="pi">-</span> <span class="s">7946/udp</span>
            <span class="pi">-</span> <span class="s">4789/udp</span>
    <span class="na">worker02</span><span class="pi">:</span>
        <span class="na">container_name</span><span class="pi">:</span> <span class="s">worker02</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">docker:dind</span>
        <span class="na">privileged</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">tty</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">depends_on</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">manager</span>
            <span class="pi">-</span> <span class="s">registry</span>
        <span class="na">expose</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="m">7946</span>
            <span class="pi">-</span> <span class="s">7946/udp</span>
            <span class="pi">-</span> <span class="s">4789/udp</span>
    <span class="na">worker03</span><span class="pi">:</span>
        <span class="na">container_name</span><span class="pi">:</span> <span class="s">worker03</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">docker:dind</span>
        <span class="na">privileged</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">tty</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">depends_on</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">manager</span>
            <span class="pi">-</span> <span class="s">registry</span>
        <span class="na">expose</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="m">7946</span>
            <span class="pi">-</span> <span class="s">7946/udp</span>
            <span class="pi">-</span> <span class="s">4789/udp</span>
</pre></table></code></div></div><details> <summary>registry을 이용한 예제</summary><div><div class="language-yaml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
</pre><td class="rouge-code"><pre><span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">3"</span>
<span class="na">services</span><span class="pi">:</span>
    <span class="na">registry</span><span class="pi">:</span>
        <span class="na">container_name</span><span class="pi">:</span> <span class="s">registry</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">registry:latest</span>
        <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">5000:5000</span>
        <span class="na">volumes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">./registry-data:/var/lib/registry"</span>
    <span class="na">manager</span><span class="pi">:</span>
        <span class="na">container_name</span><span class="pi">:</span> <span class="s">manager</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">docker:dind</span>
        <span class="na">privileged</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">tty</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">ports</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">8000:80</span>
            <span class="pi">-</span> <span class="s">9000:9000</span>
        <span class="na">depends_on</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">registry</span>
        <span class="na">expose</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="m">3375</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s2">"</span><span class="s">--insecure-registry</span><span class="nv"> </span><span class="s">registry:5000"</span>
        <span class="na">volumes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s2">"</span><span class="s">./stack:/stack"</span>
    <span class="na">worker01</span><span class="pi">:</span>
        <span class="na">container_name</span><span class="pi">:</span> <span class="s">worker01</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">docker:dind</span>
        <span class="na">privileged</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">tty</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">depends_on</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">manager</span>
            <span class="pi">-</span> <span class="s">registry</span>
        <span class="na">expose</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="m">7946</span>
            <span class="pi">-</span> <span class="s">7946/udp</span>
            <span class="pi">-</span> <span class="s">4789/udp</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s2">"</span><span class="s">--insecure-registry</span><span class="nv"> </span><span class="s">registry:5000"</span>
    <span class="na">worker02</span><span class="pi">:</span>
        <span class="na">container_name</span><span class="pi">:</span> <span class="s">worker02</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">docker:dind</span>
        <span class="na">privileged</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">tty</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">depends_on</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">manager</span>
            <span class="pi">-</span> <span class="s">registry</span>
        <span class="na">expose</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="m">7946</span>
            <span class="pi">-</span> <span class="s">7946/udp</span>
            <span class="pi">-</span> <span class="s">4789/udp</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s2">"</span><span class="s">--insecure-registry</span><span class="nv"> </span><span class="s">registry:5000"</span>
    <span class="na">worker03</span><span class="pi">:</span>
        <span class="na">container_name</span><span class="pi">:</span> <span class="s">worker03</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">docker:dind</span>
        <span class="na">privileged</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">tty</span><span class="pi">:</span> <span class="no">true</span>
        <span class="na">depends_on</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="s">manager</span>
            <span class="pi">-</span> <span class="s">registry</span>
        <span class="na">expose</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="m">7946</span>
            <span class="pi">-</span> <span class="s">7946/udp</span>
            <span class="pi">-</span> <span class="s">4789/udp</span>
        <span class="na">command</span><span class="pi">:</span> <span class="s2">"</span><span class="s">--insecure-registry</span><span class="nv"> </span><span class="s">registry:5000"</span>
</pre></table></code></div></div></div></details><p><br /></p><p>다음 아래의 명령어를 입력해주자</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ docker compose up -d
$ docker ps
</pre></table></code></div></div><p>이제 클러스터의 역활을 할 컨테이너가 4개 또는 5개가 생성된 것을 확인 할 수 있을 것이다.</p><h2 id="manager-등록">manager 등록</h2><p>원래 <code class="language-plaintext highlighter-rouge">docker swarm init</code> 명령어를 이용해 등록하면 되지만 현제 컨테이너 안에 가상클러스터를 실행했기 때문에 명령어 앞에 다음 명령어를 추가로 입력해주어야한다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ docker exec -it (실행할 타겟, manager or worker) \
(실행할 명령어)
</pre></table></code></div></div><p>따라서 메니저에서 docker swarm init 명령어를 실행하기 위해서는 다음 명령어를 실행하면 된다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ docker exec -it manager \
docker swarm init
</pre></table></code></div></div><p>명령어를 입력하면 아래에</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>$ docker swarm join --token (토큰값) (메니저IP):(port)
</pre></table></code></div></div><p>형태로 출력될텐데 다음 명령어를 복사해주자.</p><h2 id="worker-등록">worker 등록</h2><p>위에서 복사한 명령어를 worker에서 실행하면 우리가 만든 swarm 클러스터에 등록할 수 있다.<br /> 다음과 같은 방식으로 worker01 ~ worker 03까지 등록을 진행해주자.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ docker exec -it worker01 \
docker swarm join --token (토큰값) (메니저IP):(port)
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ docker exec -it worker02 \
docker swarm join --token (토큰값) (메니저IP):(port)
</pre></table></code></div></div><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ docker exec -it worker03 \
docker swarm join --token (토큰값) (메니저IP):(port)
</pre></table></code></div></div><p>이제 아래 명령어로 노드가 잘 등록됬는지 확인해보자</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ docker exec -it manager \
docker node ls
</pre></table></code></div></div><p>만약 worker node을 포함해 4개의 node가 나온다면 클러스터를 만드는데 성공한 것이다.</p><details> <summary>docker registry 이미지 등록</summary><div><h2 id="section">이미지 태그 생성</h2><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>$ docker tag (원본이미지) localhost:5000/(원본이미지)
</pre></table></code></div></div><h2 id="registry---">registry 컨테이너에 이미지 등록</h2><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>$ docker push localhost:5000/(원본이미지)
</pre></table></code></div></div><h2 id="worker---">worker 컨테이너에서 이미지 다운</h2><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ docker exec -it worker01 \
docker pull registry:5000/(원본이미지)
</pre></table></code></div></div><h2 id="section-1">이미지확인</h2><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>$ docker exec -it worker01 \
docker images
</pre></table></code></div></div></div></details><p><br /></p><h2 id="서비스-생성">서비스 생성</h2><p>swarm에서 단일 컨테이너를 배포하기 위해선 service라는 단위를 사용하는데 다음 명령어로 실행할수 있다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker service create --name [서비스이름] -p [외부포트]:[내부포트] [도커이미지]:[태그]
</pre></table></code></div></div><p>이를 테스트 해보기 위해 <a href="https://hub.docker.com/r/hashicorp/http-echo/">hashcorp/http-echo</a>이미지를 사용해보자</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>docker exec -it manager \
docker service create --name test_swarm -p 5678:5678 hashcorp/http-echo:latest
</pre></table></code></div></div><p>다음 명령어로 서비스가 생성된걸 확인할수 있다.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>docker exec -it manager \
docker service ls
</pre></table></code></div></div><p>생성된것이 확인되었으면 다음 명령어로 스케일을 조정해보자</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>docker exec -it manager \
docker service scale test_swarm=6
</pre></table></code></div></div><p>잠깐기달리면 swarm이 알아서 컨테이너를 생성해 각 노드에 분활배치한다.<br /> 그리고 service ls 명령어로 다시 확인해보면 REPLICAS가 1개에서 9개로 늘어난것을 확인할수 있다.</p><p>생성한 서비스를 삭제하기 위해선 다음 명령어를 입력하자</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>docker exec -it manager \
docker serivce rm test_swarm
</pre></table></code></div></div><h2 id="참고자료">참고자료</h2><p><a href="https://cornswrold.tistory.com/512?category=930033">스웜(swarm)을 이용한 도커 컨테이너 배포_1</a> <br /> <a href="https://subicura.com/2017/02/25/container-orchestration-with-docker-swarm.html">Docker Swarm을 이용한 쉽고 빠른 분산 서버 관리</a><br /> <a href="https://docs.docker.com/engine/swarm">docker docs</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/server/'>server</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/docker/" class="post-tag no-text-decoration" >docker</a> <a href="/tags/docker-swarm/" class="post-tag no-text-decoration" >docker-swarm</a> <a href="/tags/server/" class="post-tag no-text-decoration" >server</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=🐋 Docker swarm Orchestration - minpeter&url=https://minpeter.github.io/posts/Docker-swarm-Orchestration/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=🐋 Docker swarm Orchestration - minpeter&u=https://minpeter.github.io/posts/Docker-swarm-Orchestration/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=🐋 Docker swarm Orchestration - minpeter&url=https://minpeter.github.io/posts/Docker-swarm-Orchestration/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/logo-ls-bat/">🦢 logo-ls, bat</a><li><a href="/posts/apt-vs-dnf-,-snap-vs-flatpak/">⛷️ apt vs dnf, snap vs flatpak</a><li><a href="/posts/nvm%EC%9D%84-%EC%9D%B4%EC%9A%A9%ED%95%9C-node%EB%B2%84%EC%A0%84%EA%B4%80%EB%A6%AC/">🦎 nvm을 이용한 node버전관리 (TIL)</a><li><a href="/posts/Swarm%EC%9D%98-compose-stack/">🐙 Swarm의 compose stack</a><li><a href="/posts/stack-%EC%84%9C%EB%B9%84%EC%8A%A4%EB%A5%BC-%EC%99%B8%EB%B6%80%EC%97%90%EC%84%9C-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0/">🕸️ stack 서비스를 외부에서 사용하기</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/til/">TIL</a> <a class="post-tag" href="/tags/server/">server</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/dns/">dns</a> <a class="post-tag" href="/tags/docker-swarm/">docker-swarm</a> <a class="post-tag" href="/tags/github-pages/">github-pages</a> <a class="post-tag" href="/tags/github/">github</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/jekyll/">jekyll</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Swarm%EC%9D%98-compose-stack/"><div class="card-body"> <span class="timeago small" > Sep 12 <i class="unloaded">2021-09-12T21:05:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>🐙 Swarm의 compose stack</h3><div class="text-muted small"><p> swarm에서 compose 전에서 run명령어와 비슷한 service 명령어를 이용해 swarm에 컨테이너를 띄우고 스케일을 조정해보았다. 이번엔 compose명령어와 비슷한 stack에 대해 알아보자. 스택이란 하나 이상의 서비스를 그룹으로 묶은 단위로, 애플리케이션 저체 구성을 정의한다. 그냥 간단하게 swarm에서 작동하는 (스케일기능이 포함된...</p></div></div></a></div><div class="card"> <a href="/posts/docker-stack-visualizer/"><div class="card-body"> <span class="timeago small" > Sep 13 <i class="unloaded">2021-09-13T12:05:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>🦕 docker stack visualizer</h3><div class="text-muted small"><p> 개요 visualizer는 2016 dockercon에서 stack기능 소개를 위해 만들어진 툴이다. 이를 이용하면 swarm모드에서 노드와 컨테이너의 분포상태를 시각적으로 볼수 있다. 실습 visualizer.yaml 1 2 3 4 5 6 7 8 9 10 11 12 13 version: "3" services: app: im...</p></div></div></a></div><div class="card"> <a href="/posts/stack-%EC%84%9C%EB%B9%84%EC%8A%A4%EB%A5%BC-%EC%99%B8%EB%B6%80%EC%97%90%EC%84%9C-%EC%82%AC%EC%9A%A9%ED%95%98%EA%B8%B0/"><div class="card-body"> <span class="timeago small" > Sep 14 <i class="unloaded">2021-09-14T08:23:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>🕸️ stack 서비스를 외부에서 사용하기</h3><div class="text-muted small"><p> 기본적으로 stack에서 실행되는 서비스를 외부에 접속하기위해선 manager 노드와 연결되어야한다. 하지만 전 포스트에서 만든 echo stack은 constraints: [node.role != manager]옵션으로 매니저에서는 실행되지 않도록 설정했기 때문에 각각 컨테이너가 여러 노드에 분산되어있기때문에 전에 visualizer 서비스를 만들때...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/edge%EC%9D%98-%EB%8F%85%EC%9E%AC%EC%97%90%EC%84%9C-%EB%B2%97%EC%96%B4%EB%82%98%EA%B8%B0/" class="btn btn-outline-primary" prompt="Older"><p>🎉 edge의 독재에서 벗어나기 (TIL)</p></a> <a href="/posts/onedrive%EC%99%80-pihole/" class="btn btn-outline-primary" prompt="Newer"><p>☁️ onedrive와 pihole (TIL)</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2021 <a href="https://twitter.com/minpeter2">민웅기</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/til/">TIL</a> <a class="post-tag" href="/tags/server/">server</a> <a class="post-tag" href="/tags/docker/">docker</a> <a class="post-tag" href="/tags/dns/">dns</a> <a class="post-tag" href="/tags/docker-swarm/">docker swarm</a> <a class="post-tag" href="/tags/github-pages/">github pages</a> <a class="post-tag" href="/tags/github/">github</a> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/jekyll/">jekyll</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://minpeter.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
