---
title: ğŸ•¸ï¸ stack ì„œë¹„ìŠ¤ë¥¼ ì™¸ë¶€ì—ì„œ ì‚¬ìš©í•˜ê¸°
author: minpeter
date: 2021-09-14 08:23:00 +0900
categories: [server]
tags: [docker, swarm, server]
pin: no
---
ê¸°ë³¸ì ìœ¼ë¡œ stackì—ì„œ ì‹¤í–‰ë˜ëŠ” ì„œë¹„ìŠ¤ë¥¼ ì™¸ë¶€ì— ì ‘ì†í•˜ê¸°ìœ„í•´ì„  manager ë…¸ë“œì™€ ì—°ê²°ë˜ì–´ì•¼í•œë‹¤.  
í•˜ì§€ë§Œ ì „ í¬ìŠ¤íŠ¸ì—ì„œ ë§Œë“  echo stackì€ `constraints: [node.role != manager]`ì˜µì…˜ìœ¼ë¡œ ë§¤ë‹ˆì €ì—ì„œëŠ” ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ ì„¤ì •í–ˆê¸° ë•Œë¬¸ì— ê°ê° ì»¨í…Œì´ë„ˆê°€ ì—¬ëŸ¬ ë…¸ë“œì— ë¶„ì‚°ë˜ì–´ìˆê¸°ë•Œë¬¸ì— ì „ì— visualizer ì„œë¹„ìŠ¤ë¥¼ ë§Œë“¤ë•Œì™€ ê°™ì€ ë°©ì‹ ë˜í•œ ì‚¬ìš©í• ìˆ˜ ì—†ë‹¤.  

ë”°ë¼ì„œ í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì˜ íŠ¸ë˜í”½ì„ ë‚´ë¶€ë¡œ ë³´ë‚´ì£¼ëŠ” í”„ë¡ì‹œ ì„œë²„ë¥¼ êµ¬ì„±í•´ë³´ê² ë‹¤.  
haproxy ì´ë¯¸ì§€ë¥¼ ì‚¬ìš©í•˜ì—¬ ì™¸ë¶€íŠ¸ë˜í”½ì´ nginx ì»¨í…Œì´ë„ˆë¡œ ê°€ë„ë¡ ì„¤ì •í•´ë³´ì.  

**ingress.yaml**
```yaml
version: "3"

services:
  haproxy:
    image: dockercloud/haproxy
    networks:
      - test
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    deploy:
      mode: global
      placement:
        constraints: [node.role == manager]
    ports:
      - 80:80
      - 1936:1936 # for stats page (basic auth. stats:stats)

networks:
  test:
    external: true
```
í•´ë‹¹ í”„ë¡ì‹œëŠ” 8080í¬íŠ¸ìœ„ í˜ì´ì§€ë¥¼ ì™¸ë¶€ 80í¬íŠ¸ë¡œ ì—°ê²°í•´ì£¼ëŠ” ê°„ë‹¨í•œ í”„ë¡ì‹œì´ë‹¤.  
íŒŒì¼ managerì»¨í…Œì´ë„ˆë¡œ ì´ë™
```
$ docker cp ingress.yaml manager:/ingress.yaml
```
ì„œë¹„ìŠ¤ë°°í¬
```
$ docker exec -it manager \
docker stack deploy -c /ingress.yaml ingress
```
ì•„ë˜ ëª…ë ¹ì–´ë¡œ ì„œë¹„ìŠ¤ê°€ ì‹¤í–‰ë˜ê³  ìˆëŠ” ê²ƒì„ í™•ì¸í• ìˆ˜ ìˆë‹¤.(ë˜ëŠ” visualizerë¥¼ ì´ìš©í•´ í™•ì¸í•´ë„ëœë‹¤.)
```
$ docker exec -it manager \
docker service ls
```

ë§ˆì§€ë§‰ìœ¼ë¡œ ë¡œì»¬ì—ì„œ ë¸Œë¼ìš°ì €ë¡œ [localhost:8000](http://localhost:8000)ì— ì ‘ì†í•˜ë©´ `hello, flask!`ë¼ëŠ” ë©”ì„¸ì§€ê°€ ì¶œë ¥ë˜ëŠ”ê²ƒì„ ì•Œìˆ˜ ìˆë‹¤.  
ì´ë•Œ í”„ë¡ì‹œì„œë²„ì—ì„œ 80 í¬íŠ¸ë¡œ í¬ì›Œë”©í–ˆëŠ”ë° 8000 í¬íŠ¸ì— ì ‘ì†í•˜ëŠ” ì´ìœ ëŠ” ìš°ë¦¬ê°€ í´ëŸ¬ìŠ¤í„° ì»¨í…Œì´ë„ˆë¥¼ ë§Œë“¤ë‹¹ì‹œ managerë…¸ë“œì˜ í¬íŠ¸ë¥¼ 8000:80ìœ¼ë¡œ ì£¼ì—ˆê¸°ë•Œë¬¸ì´ë‹¤.  


## ì°¸ê³ ìë£Œ
[ìŠ¤ì›œ(swarm)ì„ ì´ìš©í•œ ë„ì»¤ ì»¨í…Œì´ë„ˆ ë°°í¬_3 (ìŠ¤ì›œ í´ëŸ¬ìŠ¤í„° ì™¸ë¶€ì—ì„œ ì„œë¹„ìŠ¤ ì‚¬ìš©í•˜ê¸°)](https://cornswrold.tistory.com/516?category=930033)  
[docker docs](https://docs.docker.com/engine/swarm/ingress/)